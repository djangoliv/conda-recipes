diff --git a/modules/rmf/dependency/RMF/plugins/vmd/CMakeLists.txt b/modules/rmf/dependency/RMF/plugins/vmd/CMakeLists.txt
index 6b9ae1c..b3510b9 100644
--- a/modules/rmf/dependency/RMF/plugins/vmd/CMakeLists.txt
+++ b/modules/rmf/dependency/RMF/plugins/vmd/CMakeLists.txt
@@ -6,17 +6,24 @@ find_path(VMDPLUGIN_INCLUDE_PATH
           )
 
 if(${VMDPLUGIN_INCLUDE_PATH} MATCHES "VMDPLUGIN_INCLUDE_PATH-NOTFOUND")
-message(STATUS "Compilation of VMD plugin disabled. Defined VMDPLUGIN_INCLUDE_DIR to point to the include path for the header.")
+message(STATUS "Compilation of VMD plugin disabled. Define VMDPLUGIN_INCLUDE_DIR to point to the include path for the header.")
 set(RMF_VMD "" CACHE INTERNAL "" FORCE)
 else()
 include_directories(${VMDPLUGIN_INCLUDE_PATH})
 
 message(STATUS "Using VMD headers found in ${VMDPLUGIN_INCLUDE_PATH}")
 
-add_library(RMF-vmd MODULE "init.cpp" "Data.cpp" "Data_read.cpp")
+include_directories(BEFORE ".")
+add_library(RMF-vmd MODULE "vmdplugin.cpp")
+if(WIN32)
+  set(DSO_SUFFIX ".dll")
+else()
+  set(DSO_SUFFIX ".so")
+endif()
 set_target_properties("RMF-vmd" PROPERTIES OUTPUT_NAME "rmfplugin"
                                 PREFIX ""
-                                SUFFIX ".so"
+                                SUFFIX "${DSO_SUFFIX}"
+                                COMPILE_DEFINITIONS "VMDPLUGIN_EXPORTS"
                                 RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib")
 set_property(TARGET "RMF-vmd" PROPERTY FOLDER "RMF")
 
diff --git a/modules/rmf/dependency/RMF/plugins/vmd/vmdplugin.cpp b/modules/rmf/dependency/RMF/plugins/vmd/vmdplugin.cpp
new file mode 100644
index 0000000..6372d4f
--- /dev/null
+++ b/modules/rmf/dependency/RMF/plugins/vmd/vmdplugin.cpp
@@ -0,0 +1,10 @@
+/* The VMD plugin macros are written assuming that the plugin is built as
+   a single compilation unit (on Windows, each #include of vmdplugin.h will
+   define the DllMain function, so it can only be included once). Work around
+   this by including all the .cpp files into this one.
+ */
+#include "Data.cpp"
+#include "Data_read.cpp"
+#include "init.cpp"
+
+
